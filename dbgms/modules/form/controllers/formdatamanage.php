<?phpif(! defined ( 'DBGMS_ROOT' )){	exit ( 'No direct script access allowed' );}/** *  功能： *  通用表单数据管理 */class FORM_Formdatamanage extends DbgMs_Admin {	public $title = 'FORM_表单数据管理';	// 当前模块 modules	public $modules = 'form';	// 当前控制器 controllers	public $con = 'formdatamanage';	public $mysql_table = '';        public $rfid;        public $exportfilename;                public function __construct($data, $jumpgroup = FALSE) {                parent::__construct($data, $jumpgroup);                $this->admin_data['search_url'] = $this->admin_data['curr_url'] . '&rfid=' . $rfid . '&page=';                $this->admin_data['exportformdata_url'] = $this->admin_data['con_url'] . '&act=exportformdata';                $this->rfid = dbg_input_getpost ( 'rfid' );        }	// @action:默认列表	public function index()	{                $this->getpage ();                $rfid = $this->rfid;                $this->admin_data['rfid'] = $rfid;                $keytag = dbg_input_getpost ( 'keytag' );                $q = trim(dbg_input_getpost ( 'q' ));                $this->admin_data['q'] = $q;                $this->admin_data['keytag'] = $keytag;                                $q_sql = '';                if($q != '' && $keytag != 'id' && $keytag != 'operatetime'){                        $q_sql .= " AND `{$keytag}` like '%{$q}%' ";                }elseif($q != '' && $keytag == 'id'){                        $q_sql .= " AND `id`='$q' ";                }elseif($q != '' && $keytag == 'operatetime'){                        $date = explode('-', $q);                        $num = count($date);                        if($num == 1){//年                    		$start = strtotime($q.'-1-1');                    		$end = strtotime("+1 years", $start)-1;                        }elseif($num == 2){//年月                    		$start = strtotime($q.'-1');                    		$end = strtotime("+1 months", $start)-1;                        }elseif($num == 3){//年月日                		$start = strtotime($q);                		$end = $start + 86400-1;                        }                        $q_sql .= " AND operatetime >= $start AND operatetime <= $end ";                }                $url_var = "&q=$q&keytag=$keytag";                $this->admin_data['q_sql'] = $q_sql;                                // 获取基本数据信息                $basedata = $this->getbasedata();                $this->admin_data['basedata'] = $this->getbasedata();                                // 获取需要展示的字段                $needshowfields = $this->getcolumnname();                                // 根据字段获取数据                $this->admin_data['lists'] = $this->getneedsdata($needshowfields,$basedata,$q_sql);                                $needshowfields = array_merge($needshowfields, array(0=>array('attrname' => 'operatetime','nametag'  => '操作时间')));                $this->admin_data['needshowfields'] = $needshowfields;                		// 当前数据表内容总数		$total = dbg_query ( 'SELECT COUNT(id) AS d FROM `' . $basedata['tablename'] . '` WHERE 1=1 '. $q_sql );                $url = $this->admin_data['curr_url'] . '&rfid=' . $rfid . $url_var . '&page='; // 页脚url                $this->admin_data['pagebreak'] = $this->pagebreak ( $this->page, $total[0]['d'], $this->pagesize, $url);                		// 当前数据表内容列表                $this->admin_data['views'] = _DBGMS_MODULES_ . 'form/views/'.$this->con.'/'.__FUNCTION__.'.php';		$this->load_view ();	}                /*         * @action：删除         */        public function delete(){		$id = dbg_input_getpost ( 'id' );		$rfid = dbg_input_getpost ( 'rfid' );                                //获取表名                $basedata = dbg_query('SELECT tablename FROM `dbg_richform` WHERE rfid="'.$rfid.'"',true);                $tablename = $basedata[0]['tablename'];		if($id != NULL)		{                    			$relust_sql = dbg_query ( 'DELETE FROM `' . $tablename . '` WHERE id=' . $id, FALSE );			if($relust_sql == TRUE)			{				$result_json['StatusCode'] = 200;				$result_json['id'] = $id;			}			else			{				$result_json['StatusCode'] = 404;				$result_json['msg'] = "删除失败,数据操作错误！";			}			echo json_encode ( $result_json );			exit ();		}		else		{			redirect ( $this->admin_data['con_url'] ); // 返回列表			exit ();		}        }                /*         * @action 导出数据         */        public function exportformdata(){                            //获取数据条件设置                $q_sql = dbg_input_getpost('q_sql');                                //获取数据                $datalist = $this->getexportdata($q_sql);                                // 获取需要展示的字段                $needshowfields = $this->getcolumnname();                $needshowfields = array_merge($needshowfields, array(0=>array('attrname' => 'operatetime','nametag'  => '操作时间')));                                // 写入文件                $fileuri = $this->writeexcle($needshowfields,$datalist);                $filename = $this->exportfilename;                $file  = fopen($fileuri,"r");                Header("Content-type:application/octet-stream");                Header("Accept-Ranges:bytes");                header("Content-Type:application/msexcel");                Header("Accept-Length:".filesize($fileuri));                Header("Content-Disposition:attachment;filename=".$filename);                echo fread($file, filesize($fileuri));                fclose($file);                unlink($fileuri);        }                /*         * 获取列标题 用于展示到excel中         */        protected function getcolumnname(){                                $tablename = dbg_query("SELECT tablename FROM `dbg_richform` WHERE rfid=".$this->rfid, true);                $tablename = $tablename[0]['tablename'];                                $columaname = dbg_query('SELECT attrname,nametag FROM `dbg_form_element` WHERE rfid="'.$this->rfid.'"'                        . ' AND isrecord=1 AND isshow=1 AND enable=1 ORDER BY sortnum DESC',true);                                return $this->uniquename($columaname);        }                /*         * 让字段唯一         */        protected function uniquename($list = array()){                $needshowfields = $list;                foreach ($list as $key => $value) {                        $conflictnum = 0;                        foreach ($needshowfields as $key1 => $value1) {                                if($value['attrname'] == $value1['attrname']){                                        $conflictnum++;                                        $conflictattrname = $value['attrname'];                                }                                if($conflictnum == 2){                                        unset($needshowfields[$key]);                                }                        }                }                $needshowfields = array_merge(array(0=>array('attrname' => 'id','nametag'  => '数据id')), $needshowfields);                return $needshowfields;        }                /*         * 根据需要获取数据         */        protected function getneedsdata($needshowfields = array(), $basedata = array(), $q_sql = ''){                $sql = 'SELECT ';                foreach ($needshowfields as $key => $value) {                        $sql .= "`{$value['attrname']}`, ";                }                $sql .= " operatetime FROM `{$basedata['tablename']}` WHERE 1=1 " . $q_sql . " ORDER BY id DESC LIMIT " . ($this->page - 1) * $this->pagesize . "," . $this->pagesize;                return dbg_query ( $sql );        }                /*         * 获取表单基本信息         */        protected function getbasedata(){                $basedata = dbg_query('SELECT rfname,bindproduct,tablename FROM `dbg_richform` WHERE rfid="'.$this->rfid.'"',true);                $basedata = $basedata[0];                return $basedata;        }                /*         * 获取需要导出的数据         */        protected function getexportdata($q_sql = ''){                $columnnamelist = $this->getcolumnname();                $columnnamelist = array_merge($columnnamelist, array(0=>array('attrname' => 'operatetime','nametag'  => '操作时间')));                // 获取基本数据信息                $basedata = $this->getbasedata();                $sql = 'SELECT ';                foreach ($columnnamelist as $key => $value) {                        $sql .= "`{$value['attrname']}`, ";                }                $sql .= " operatetime FROM `{$basedata['tablename']}` WHERE 1=1 " . $q_sql . " ORDER BY id DESC ";                return dbg_query ( $sql );        }                /*         * 写入excel文件         */        protected function writeexcle($needshowfields = array(), $datalist = array()){                //设置临时存储路径                $storagedir = DBG_DATA.'exportdata/';                if( !is_dir($storagedir) ){                    mkdir($storagedir, 0777);                }                                //加载phpexcel类库                require_once _DBGMS_CLASS_.'PHPExcel.php';                                //实例化类对象                $objPHPExcel = new PHPExcel();                // 设置文档属性                $objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel2007');                $objPHPExcel->getProperties()->setCreator("Maarten Balliauw")                    ->setLastModifiedBy("Maarten Balliauw")                    ->setTitle("PHPExcel Test Document")                    ->setSubject("PHPExcel Test Document")                    ->setDescription("Test document for PHPExcel, generated using PHP classes.")                    ->setKeywords("office PHPExcel php")                    ->setCategory("Test result file");                $basedata = $this->getbasedata();                $filename = $basedata['tablename'].date('Y-m-d-H-i-s',time());                                //修改默认的标题                $objPHPExcel->getActiveSheet()->setTitle($filename);                //设置当前的工作窗口                $objPHPExcel->setActiveSheetIndex(0);                                //宽度自适应                $chr = 'A';                for($i=0; $i<26; $i++){                        //$objPHPExcel->getActiveSheet()->getColumnDimension($chr)->setAutoSize(true);                        $objPHPExcel->getActiveSheet()->getColumnDimension($chr)->setWidth(20);                        $valint = ord($chr) + 1;                        $chr = chr($valint);                }                                //设置值 通过坐标 列 行 值                foreach ($needshowfields as $key => $value) {                        $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($key, 1, $value['nametag']);                }                                $row = 2;                foreach ($datalist as $key => $value) {                        $i = 0;                        foreach ($value as $key1 => $value1) {                                if($key1 == 'operatetime'){                                        $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($i++, $row, date('Y-m-d',$value1));                                }else{                                        $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($i++, $row, $value1);                                }                                                        }                        $row++;                }                // 文件保存                $fileuri = $storagedir.$filename.'.xlsx';                $objWriter->save($fileuri);                $this->exportfilename = $filename.'.xlsx';                                // 关闭资源                $objPHPExcel->disconnectWorksheets();                 unset($objPHPExcel);                unset($objWriter);                return $fileuri;        }}